const state = {
    tokens: {},
    users: {},
};

const accounts = {
    dispatcher: { password: 'dispatcher123', label: '调度' },
    tech: { password: 'tech123', label: '技师' },
    wh: { password: 'wh123', label: '库管' },
    viewer: { password: 'viewer123', label: '查看' },
};

const logArea = document.getElementById('global-log');

function log(message, payload, isError = false) {
    const time = new Date().toLocaleTimeString();
    const entry = `[${time}] ${isError ? '❌' : '✅'} ${message}`;
    const details = payload ? `\n${typeof payload === 'string' ? payload : formatJson(payload)}` : '';
    logArea.textContent = `${entry}${details}\n\n${logArea.textContent}`.trim();
}

function formatJson(data) {
    try {
        return JSON.stringify(data, null, 2);
    } catch (err) {
        return String(data);
    }
}

function updateTokenList() {
    const list = document.getElementById('token-list');
    list.innerHTML = '';
    Object.entries(state.tokens).forEach(([role, token]) => {
        const li = document.createElement('li');
        const user = state.users[role];
        const short = token.slice(0, 12);
        li.textContent = `${accounts[role]?.label ?? role}：${user?.username ?? role} (${short}…)`;
        list.appendChild(li);
    });
}

async function login(username, password) {
    const button = document.querySelector('#login-form button[type="submit"]');
    button.disabled = true;
    try {
        const res = await fetch('/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
        });
        const json = await res.json();
        if (!res.ok) {
            throw new Error(json.message || res.statusText);
        }
        const payload = json.data;
        const role = payload.user.role;
        state.tokens[role] = payload.token;
        state.users[role] = payload.user;
        updateTokenList();
        log(`登录成功：${payload.user.username}`, payload);
        return payload;
    } catch (error) {
        log(`登录失败：${username}`, error.message || error, true);
        throw error;
    } finally {
        button.disabled = false;
    }
}

function serializeForm(form) {
    const data = {};
    const elements = Array.from(form.elements).filter((el) => el.name && el.type !== 'submit' && el.type !== 'button');
    for (const el of elements) {
        if (el.disabled) continue;
        if (el.type === 'checkbox') {
            data[el.name] = el.checked;
            continue;
        }
        let value = el.value;
        if (el.type === 'datetime-local') {
            if (!value) {
                value = '';
            } else {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    continue;
                }
                value = date.toISOString();
            }
        }
        if (el.dataset.boolean === 'true') {
            value = value === 'true' || value === '1';
        }
        if (el.dataset.number === 'true') {
            if (value === '') {
                continue;
            }
            value = Number(value);
        }
        if (el.dataset.array === 'csv') {
            value = value
                ? value
                      .split(',')
                      .map((item) => item.trim())
                      .filter(Boolean)
                : [];
            data[el.name] = value;
            continue;
        }
        if (el.type === 'number') {
            if (value === '') {
                continue;
            }
            value = Number(value);
        }
        if (typeof value === 'string') {
            value = value.trim();
        }
        if (el.name === 'content_text') {
            data[el.name] = value;
            continue;
        }
        if (value === '' || value === null || value === undefined) {
            continue;
        }
        data[el.name] = value;
    }
    return data;
}

function preparePayload(form, raw) {
    const payload = { ...raw };
    if (Object.prototype.hasOwnProperty.call(payload, 'content_text')) {
        const text = payload.content_text || 'Demo attachment generated by前端控制台';
        payload.content = toBase64(text);
        delete payload.content_text;
    }
    if (Object.prototype.hasOwnProperty.call(payload, 'passed') && typeof payload.passed === 'string') {
        payload.passed = payload.passed === 'true';
    }
    return payload;
}

function resolveEndpoint(form, data) {
    let endpoint = form.dataset.endpoint;
    if (endpoint.includes('{id}')) {
        const pathId = data.path_id;
        if (pathId === undefined || pathId === null) {
            throw new Error('请填写工单ID');
        }
        endpoint = endpoint.replace('{id}', String(pathId));
        delete data.path_id;
    }
    return endpoint;
}

function toBase64(str) {
    const utf8 = encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (_, p1) => String.fromCharCode(parseInt(p1, 16)));
    return btoa(utf8);
}

async function sendRequest(form) {
    const method = (form.dataset.method || 'POST').toUpperCase();
    const role = form.dataset.role;
    if (role && !state.tokens[role]) {
        throw new Error(`请先登录 ${accounts[role]?.label || role} 账号`);
    }
    const rawData = serializeForm(form);
    const endpoint = resolveEndpoint(form, rawData);
    const payload = preparePayload(form, rawData);
    const headers = {};
    let url = endpoint;
    const options = { method, headers };
    if (role && state.tokens[role]) {
        headers['Authorization'] = `Bearer ${state.tokens[role]}`;
    }
    if (method === 'GET') {
        const params = new URLSearchParams();
        Object.entries(payload).forEach(([key, value]) => {
            if (Array.isArray(value)) {
                value.forEach((item) => params.append(`${key}[]`, item));
            } else if (value !== '' && value !== null && value !== undefined) {
                params.append(key, String(value));
            }
        });
        if (params.toString()) {
            url = `${url}?${params.toString()}`;
        }
    } else {
        headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(payload);
    }
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
    }
    try {
        const res = await fetch(url, options);
        const json = await res.json().catch(() => ({}));
        if (!res.ok) {
            const message = json.message || res.statusText || '请求失败';
            throw new Error(message);
        }
        return json;
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
        }
    }
}

function bindForms() {
    const forms = document.querySelectorAll('form.api-form');
    forms.forEach((form) => {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const resultEl = form.querySelector('.result');
            if (resultEl) {
                resultEl.textContent = '请求中...';
            }
            try {
                const response = await sendRequest(form);
                if (resultEl) {
                    resultEl.textContent = formatJson(response);
                }
                const method = (form.dataset.method || 'POST').toUpperCase();
                log(`${method} ${form.dataset.endpoint}`, response);
            } catch (error) {
                if (resultEl) {
                    resultEl.textContent = error.message || String(error);
                }
                log(`${form.dataset.method || 'POST'} ${form.dataset.endpoint}`, error.message || error, true);
            }
        });
    });
}

function bindLogin() {
    const form = document.getElementById('login-form');
    const usernameSelect = document.getElementById('login-username');
    const passwordInput = document.getElementById('login-password');
    usernameSelect.addEventListener('change', () => {
        const selected = usernameSelect.selectedOptions[0];
        passwordInput.value = selected?.dataset.password || '';
    });
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const username = usernameSelect.value;
        const password = passwordInput.value;
        try {
            await login(username, password);
        } catch (err) {
            // 已在 login 中记录
        }
    });
}

bindLogin();
bindForms();
updateTokenList();
log('提示', '选择角色后点击“获取 Token”完成登录，再依次执行下方操作表单。');
